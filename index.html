<!DOCTYPE html>
<html lang="ru">
<head>
  <!-- AdSense (–æ—Å—Ç–∞–≤–ª—è–µ–º –≤–∞—à ID) -->
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4258758862980138" crossorigin="anonymous"></script>
  <meta name="google-adsense-account" content="ca-pub-4258758862980138">

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>RemontCalc ‚Äî –†–∞—Å—á—ë—Ç –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤</title>
  <meta name="theme-color" content="#bdbdbd">
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="icon-192.png" type="image/png">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="RemontCalc">
  <link rel="apple-touch-icon" href="icon-512.png">

  <!-- Roboto font for PDF and UI -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <!-- Material Symbols -->
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,300..700,0..1,0..200" rel="stylesheet">

  <!-- jsPDF and html2canvas (–¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ —ç–∫—Å–ø–æ—Ä—Ç–∞ –∫–∏—Ä–∏–ª–ª–∏—Ü—ã) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <style>
    :root{ --bg:#ececec; --card:#ffffff; --accent:#2e7d32; --accent-2:#fb8c00; --muted:#6b6b6b; --radius:14px }
    *{box-sizing:border-box}
    body{ margin:0; font-family: 'Roboto', 'Segoe UI', Roboto, Arial, sans-serif; background:linear-gradient(180deg,var(--bg),#efefef 60%); color:#222 }
    header.appbar{ background:linear-gradient(180deg,#cfcfcf,#bdbdbd); padding:12px 16px; display:flex; align-items:center; gap:12px; position:sticky; top:0; z-index:40 }
    .logo{ width:44px; height:44px; border-radius:10px; display:flex; align-items:center; justify-content:center; background:linear-gradient(135deg,var(--accent),var(--accent-2)); color:white; font-weight:700 }
    header h1{ margin:0; font-size:18px }
    header .right{ margin-left:auto; display:flex; gap:8px; align-items:center }
    .container{ max-width:980px; margin:16px auto; padding:12px }
    .controls{ display:flex; gap:10px; margin-bottom:12px; align-items:center; flex-wrap:wrap }
    .btn{ padding:10px 12px; border-radius:12px; border:none; background:#fff; box-shadow:0 2px 6px rgba(0,0,0,.06); cursor:pointer }
    .btn.primary{ background:linear-gradient(135deg,var(--accent),#1b5e20); color:#fff }
    .card{ background:var(--card); border-radius:var(--radius); padding:14px; box-shadow:0 8px 20px rgba(0,0,0,.06); margin-bottom:12px }
    label{ display:flex; align-items:center; gap:8px; justify-content:space-between; margin:8px 0; flex-wrap:wrap }
    input[type="number"], input[type="text"], select{ padding:8px 10px; border-radius:10px; border:1px solid #d0d0d0; min-width:76px; text-align:center }
    .dim-group{ display:inline-flex; gap:6px; align-items:center }
    .result{ background:linear-gradient(180deg,#f7fff8,#e8f5e9); border-left:4px solid var(--accent); padding:10px; border-radius:8px; margin-top:8px; font-weight:600 }
    .price-row{ display:flex; gap:8px; align-items:center; flex-wrap:wrap }
    .fab-container{ position:fixed; right:18px; bottom:18px; display:flex; flex-direction:column; gap:10px }
    .fab{ width:56px; height:56px; border-radius:50%; display:flex; align-items:center; justify-content:center; box-shadow:0 8px 18px rgba(0,0,0,.16); border:none }
    .ad-note{ font-size:12px; color:var(--muted); margin-bottom:8px; text-align:center }
    .buy-btn{ display:inline-block; padding:8px 10px; border-radius:8px; background:linear-gradient(135deg,#ffb74d,#fb8c00); color:#fff; text-decoration:none }
    /* hidden printable report */
    #reportPrint { position:fixed; left:-9999px; top:-9999px; width:800px; background:white; padding:20px; font-family: 'Roboto', sans-serif; color:#111 }
    @media(min-width:900px){ .container{ padding:0 } }
  </style>
</head>
<body>
  <header class="appbar">
    <div class="logo">RC</div>
    <div>
      <h1>RemontCalc</h1>
      <div style="font-size:12px;color:var(--muted)">–†–∞—Å—á—ë—Ç –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ ‚Äî RemontCalc</div>
    </div>

    <div class="right">
      <label style="margin:0;display:flex;align-items:center;gap:8px">
        <span style="font-size:13px;color:var(--muted)">–í–∞–ª—é—Ç–∞</span>
        <select id="currencySelect" style="padding:8px;border-radius:8px">
          <option value="KZT">‚Ç∏</option>
          <option value="RUB">‚ÇΩ</option>
          <option value="USD">$</option>
          <option value="EUR">‚Ç¨</option>
        </select>
      </label>
    </div>
  </header>

  <main class="container">
    <div class="controls">
      <button id="addWallBtnTop" class="btn"><span class="material-symbols-outlined">wallpaper</span> –î–æ–±–∞–≤–∏—Ç—å —Å—Ç–µ–Ω—É</button>
      <button id="addMaterialTop" class="btn"><span class="material-symbols-outlined">add_box</span> –î–æ–±–∞–≤–∏—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª</button>
      <div style="flex:1"></div>
      <button id="saveProject" class="btn primary"><span class="material-symbols-outlined">save</span> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <button id="loadProject" class="btn"><span class="material-symbols-outlined">folder_open</span> –ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
      <button id="clearProject" class="btn" style="background:linear-gradient(135deg,#ef5350,#e53935);color:#fff"><span class="material-symbols-outlined">delete</span> –û—á–∏—Å—Ç–∏—Ç—å</button>
      <button id="exportPdf" class="btn" title="–°–∫–∞—á–∞—Ç—å PDF">üìÑ –°–∫–∞—á–∞—Ç—å PDF</button>
    </div>

    <section>
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px"><h2 style="margin:0">–°—Ç–µ–Ω—ã</h2><small style="color:var(--muted)">meeting_room</small></div>
      <div id="walls"></div>
      <div style="margin-top:8px"><button id="addWall" class="btn" style="width:100%">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å—Ç–µ–Ω—É</button></div>
    </section>

    <div id="ad-area" class="card" aria-hidden="false">
      <div style="width:100%;max-width:760px;margin:0 auto">
        <div class="ad-note">–†–µ–∫–ª–∞–º–∞ ‚Äî –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞</div>
        <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-4258758862980138" data-ad-slot="1234567890" data-ad-format="auto"></ins>
        <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
      </div>
    </div>

    <section>
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px"><h2 style="margin:0">–ú–∞—Ç–µ—Ä–∏–∞–ª—ã</h2><small style="color:var(--muted)">inventory_2</small></div>
      <div id="materials"></div>
      <!-- –Ω–∏–∂–Ω—è—è –¥—É–±–ª–∏—Ä—É—é—â–∞—è –∫–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∞; –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ ‚Äî —Å–≤–µ—Ä—Ö—É -->
    </section>
  </main>

  <div class="fab-container" role="toolbar" aria-label="–ü—Ä–æ–µ–∫—Ç">
    <button class="fab" id="fabSave" title="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å" style="background:linear-gradient(135deg,var(--accent),#27632a);color:#fff">üíæ</button>
    <button class="fab" id="fabLoad" title="–ó–∞–≥—Ä—É–∑–∏—Ç—å" style="background:linear-gradient(135deg,#ffb74d,#fb8c00);">üìÇ</button>
    <button class="fab" id="fabClear" title="–û—á–∏—Å—Ç–∏—Ç—å" style="background:linear-gradient(135deg,#ef5350,#e53935);">üóë</button>
  </div>

  <!-- –°–∫—Ä—ã—Ç—ã–π –±–ª–æ–∫ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ PDF —á–µ—Ä–µ–∑ html2canvas (—á—Ç–æ–±—ã –∫–∏—Ä–∏–ª–ª–∏—Ü–∞ —Ä–µ–Ω–¥–µ—Ä–∏–ª–∞—Å—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ) -->
  <div id="reportPrint" aria-hidden="true"></div>

  <script>
    // ---- core data and helpers ----
    const wallsContainer = document.getElementById('walls');
    const materialsContainer = document.getElementById('materials');
    const currencySelect = document.getElementById('currencySelect');
    let currency = localStorage.getItem('remontcalc_currency') || 'KZT';
    currencySelect.value = currency;
    const currencySymbols = { KZT: '‚Ç∏', RUB: '‚ÇΩ', USD: '$', EUR: '‚Ç¨' };

    let walls = []; let wallCount = 0; const DEFAULT_UNIT = 'm';
    const parseNum = v => parseFloat(v) || 0;
    const toM = (v,u)=>u==='cm'?v/100:v;
    const findWall = id => walls.find(w => w.id == id);

    // ---- storage ----
    function saveToStorage(){
      const data = { currency, walls, materials: [...materialsContainer.querySelectorAll('.material')].map(m=>({
        type: m.querySelector('.type').value,
        target: m.querySelector('.target').value,
        len: parseNum(m.querySelector('.mlen').value),
        wid: parseNum(m.querySelector('.mwid').value),
        lenUnit: m.querySelectorAll('.unit-select')[0]?.value,
        widUnit: m.querySelectorAll('.unit-select')[1]?.value,
        orient: m.querySelector('input[type="radio"]:checked')?.value || 'vertical',
        price: parseNum(m.querySelector('.price')?.value)
      })) };
      localStorage.setItem('repair_calc_project', JSON.stringify(data));
      localStorage.setItem('remontcalc_currency', currency);
    }

    function loadFromStorage(){
      const data = JSON.parse(localStorage.getItem('repair_calc_project') || '{}');
      if (!data.walls) return;
      walls = []; wallsContainer.innerHTML = ''; materialsContainer.innerHTML = ''; wallCount = 0;
      if (data.currency) { currency = data.currency; currencySelect.value = currency; }
      data.walls.forEach(w=>createWall(w));
      data.materials?.forEach(m=>{
        const div = createMaterial(m);
        div.querySelector('.type').value = m.type;
        div.querySelector('.target').value = m.target;
        div.querySelector('.mlen').value = m.len;
        div.querySelector('.mwid').value = m.wid;
        div.querySelectorAll('.unit-select')[0].value = m.lenUnit;
        div.querySelectorAll('.unit-select')[1].value = m.widUnit;
        if (m.type === 'panel') div.querySelectorAll('input[type="radio"]').forEach(r=>r.checked=(r.value===m.orient));
        if (m.price) div.querySelector('.price').value = m.price;
      });
      updateTargets();
    }

    function clearStorage(){ if (confirm('–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë?')){ localStorage.removeItem('repair_calc_project'); location.reload(); } }

    // ---- UI bindings ----
    document.getElementById('saveProject').onclick = ()=>{ saveToStorage(); alert('‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!'); };
    document.getElementById('loadProject').onclick = loadFromStorage;
    document.getElementById('clearProject').onclick = clearStorage;
    document.getElementById('fabSave').onclick = ()=>document.getElementById('saveProject').click();
    document.getElementById('fabLoad').onclick = ()=>document.getElementById('loadProject').click();
    document.getElementById('fabClear').onclick = ()=>document.getElementById('clearProject').click();
    document.getElementById('addWallBtnTop').onclick = ()=>{ createWall(); saveToStorage(); };
    document.getElementById('addMaterialTop').onclick = ()=>{ createMaterial(); saveToStorage(); };

    currencySelect.onchange = ()=>{ currency = currencySelect.value; localStorage.setItem('remontcalc_currency', currency); updateAllResults(); };

    // ---- unit select html helper ----
    const unitSelectHtml = (def=DEFAULT_UNIT)=>`
      <select class="unit-select">
        <option value="m" ${""} >–º</option>
        <option value="cm" ${""} >—Å–º</option>
      </select>`;

    function updateTargets(){
      document.querySelectorAll('.target').forEach(sel=>{
        const prev = sel.value;
        sel.innerHTML = '<option value="">- –í—ã–±–µ—Ä–∏—Ç–µ —Ü–µ–ª—å -</option>';
        if (walls.length>0) sel.innerHTML += `<option value="all-walls">–í—Å–µ —Å—Ç–µ–Ω—ã</option><option value="all-floors">–í—Å–µ –ø–æ–ª—ã</option>`;
        walls.forEach(w=>{
          const area = toM(w.length,w.unit)*toM(w.height,w.unit);
          sel.innerHTML += `<option value="wall-${w.id}">–°—Ç–µ–Ω–∞ ${w.id} (${area.toFixed(2)} –º¬≤)</option>`;
          if (w.floor){ const fa = toM(w.floor.length,w.floor.unit)*toM(w.floor.width,w.floor.unit); sel.innerHTML += `<option value="floor-${w.id}">–ü–æ–ª ${w.id} (${fa.toFixed(2)} –º¬≤)</option>`; }
        });
        if ([...sel.options].some(o=>o.value===prev)) sel.value = prev;
      });
    }

    // ---- walls ----
    function createWall(existing=null){
      wallCount++; const id = wallCount;
      const wall = existing || { id, length:0, height:0, unit:DEFAULT_UNIT, inner:0, outer:0, floor:null };
      wall.id = id; walls.push(wall);

      const div = document.createElement('div'); div.className = 'wall card';
      div.innerHTML = `
        <h4>–°—Ç–µ–Ω–∞ ${id}</h4>
        <label>–î–ª–∏–Ω–∞: <span class="dim-group"><input type="number" class="len" value="${wall.length}">${unitSelectHtml(wall.unit)}</span></label>
        <label>–í—ã—Å–æ—Ç–∞: <span class="dim-group"><input type="number" class="hei" value="${wall.height}">${unitSelectHtml(wall.unit)}</span></label>
        <label>–í–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö —É–≥–ª–æ–≤: <input type="number" class="in" value="${wall.inner}" min="0" max="10" style="width:60px;"></label>
        <label>–ù–∞—Ä—É–∂–Ω—ã—Ö —É–≥–ª–æ–≤: <input type="number" class="out" value="${wall.outer}" min="0" max="10" style="width:60px;"></label>
        <label><input type="checkbox" class="fchk" ${wall.floor?'checked':''}> –£—á–∏—Ç—ã–≤–∞—Ç—å –ø–æ–ª</label>
        <div class="floor" style="display:${wall.floor?'block':'none'};">
          <label>–î–ª–∏–Ω–∞ –ø–æ–ª–∞: <span class="dim-group"><input type="number" class="flen" value="${wall.floor?.length||0}">${unitSelectHtml(wall.floor?.unit||'m')}</span></label>
          <label>–®–∏—Ä–∏–Ω–∞ –ø–æ–ª–∞: <span class="dim-group"><input type="number" class="fwid" value="${wall.floor?.width||0}">${unitSelectHtml(wall.floor?.unit||'m')}</span></label>
        </div>
        <div style="display:flex; gap:8px; margin-top:8px;">
          <button class="btn" style="background:linear-gradient(135deg,#ef5350,#e53935);color:#fff" onclick="this.closest('.wall').remove();">–£–¥–∞–ª–∏—Ç—å</button>
        </div>
      `;

      const upd = ()=>{ updateTargets(); saveToStorage(); };
      div.querySelector('.len').oninput = e=>{ wall.length = parseNum(e.target.value); upd(); };
      div.querySelector('.hei').oninput = e=>{ wall.height = parseNum(e.target.value); upd(); };
      div.querySelector('.in').oninput = e=>{ wall.inner = parseNum(e.target.value); upd(); };
      div.querySelector('.out').oninput = e=>{ wall.outer = parseNum(e.target.value); upd(); };
      div.querySelectorAll('.unit-select')[0].onchange = e=>{ wall.unit = e.target.value; upd(); };
      div.querySelectorAll('.unit-select')[1].onchange = e=>{ wall.unit = e.target.value; upd(); };
      const fchk = div.querySelector('.fchk');
      fchk.onchange = ()=>{ const floorDiv = div.querySelector('.floor'); if (fchk.checked){ floorDiv.style.display='block'; wall.floor = { length:0, width:0, unit:DEFAULT_UNIT }; } else { floorDiv.style.display='none'; wall.floor = null; } upd(); };
      div.querySelector('.flen').oninput = e=>{ if (wall.floor) wall.floor.length = parseNum(e.target.value); upd(); };
      div.querySelector('.fwid').oninput = e=>{ if (wall.floor) wall.floor.width = parseNum(e.target.value); upd(); };
      div.querySelectorAll('.floor .unit-select').forEach(s=>s.onchange = e=>{ if (wall.floor) wall.floor.unit = e.target.value; upd(); });
      div.querySelector('.btn').onclick = ()=>{ walls = walls.filter(w=>w.id!==id); div.remove(); upd(); };

      wallsContainer.appendChild(div); updateTargets();
    }

    // ---- materials ----
    function createMaterial(existing=null){
      const div = document.createElement('div'); div.className = 'material card';
      const uid = Date.now()+Math.random();
      div.innerHTML = `
        <h4>–ú–∞—Ç–µ—Ä–∏–∞–ª</h4>
        <label>–¢–∏–ø:
          <select class="type">
            <option value="tile">–ü–ª–∏—Ç–∫–∞</option>
            <option value="plinth">–ü–ª–∏–Ω—Ç—É—Å</option>
            <option value="linoleum">–õ–∏–Ω–æ–ª–µ—É–º</option>
            <option value="panel">–°—Ç–µ–Ω–æ–≤–∞—è –ø–∞–Ω–µ–ª—å</option>
            <option value="wallpaper">–û–±–æ–∏</option>
          </select>
        </label>
        <label>–ü—Ä–∏–º–µ–Ω–∏—Ç—å –∫: <select class="target"></select></label>
        <label><span>–î–ª–∏–Ω–∞:</span><span class="dim-group"><input type="number" class="mlen" value="${existing?.len||0}">${unitSelectHtml(existing?.lenUnit||'m')}</span></label>
        <label><span>–®–∏—Ä–∏–Ω–∞:</span><span class="dim-group"><input type="number" class="mwid" value="${existing?.wid||0}">${unitSelectHtml(existing?.widUnit||'m')}</span></label>
        <div class="price-row">
          <label style="flex:1">–¶–µ–Ω–∞ –∑–∞ –µ–¥.: <input type="number" step="0.01" class="price" value="${existing?.price||0}" placeholder="0"></label>
          <div style="align-self:center"> <small style="color:var(--muted)">(${currencySymbols[currency] || '‚Ç∏'})</small></div>
        </div>
        <div class="orientation" style="display:none;">
          <span style="font-weight:500;color:#444;">–ú–æ–Ω—Ç–∞–∂ –ø–∞–Ω–µ–ª–µ–π:</span>
          <label><input type="radio" name="orient-${uid}" value="vertical" checked> –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ</label>
          <label><input type="radio" name="orient-${uid}" value="horizontal"> –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ</label>
        </div>
        <div style="display:flex; gap:8px; margin-top:8px;">
          <button class="btn calc">–†–∞—Å—Å—á–∏—Ç–∞—Ç—å</button>
          <button class="btn" onclick="this.closest('.material').remove(); updateTargets(); saveToStorage(); return false;">–£–¥–∞–ª–∏—Ç—å</button>
        </div>
        <div class="result"></div>
      `;

      materialsContainer.appendChild(div); updateTargets();
      const typeSel = div.querySelector('.type'); const orientDiv = div.querySelector('.orientation');
      const refresh = ()=>{ orientDiv.style.display = typeSel.value==='panel' ? 'flex' : 'none'; saveToStorage(); };
      typeSel.onchange = refresh; refresh();

      div.querySelector('.price').oninput = ()=>{ updateAllResults(); saveToStorage(); };

      div.querySelector('.calc').onclick = ()=>{
        const type = div.querySelector('.type').value;
        const target = div.querySelector('.target').value;
        const len = parseNum(div.querySelector('.mlen').value);
        const wid = parseNum(div.querySelector('.mwid').value);
        const lenUnit = div.querySelectorAll('.unit-select')[0]?.value||'m';
        const widUnit = div.querySelectorAll('.unit-select')[1]?.value||'m';
        const res = div.querySelector('.result');
        if (!target){ res.innerHTML='‚ùå –í—ã–±–µ—Ä–∏—Ç–µ —Ü–µ–ª—å'; return; }
        if (len<=0){ res.innerHTML='‚ö†Ô∏è –í–≤–µ–¥–∏—Ç–µ –¥–ª–∏–Ω—É –º–∞—Ç–µ—Ä–∏–∞–ª–∞'; return; }
        let count = 0;

        if (type==='plinth'){
          let total = 0; if (target==='all-walls') walls.forEach(w=> total+=toM(w.length,w.unit));
          else if (target.startsWith('wall-')){ const w=findWall(target.split('-')[1]); if (w) total = toM(w.length,w.unit); }
          count = total / toM(len,lenUnit);
        } else if (type==='panel'){
          const orient = div.querySelector('input[type="radio"]:checked')?.value || 'vertical';
          let total = 0; if (target==='all-walls'){
            walls.forEach(w=>{
              const L = toM(w.length,w.unit), H = toM(w.height,w.unit);
              const pL = toM(len,lenUnit), pW = toM(wid,widUnit);
              total += orient==='vertical' ? Math.ceil(H/pL)*Math.ceil(L/pW) : Math.ceil(H/pW)*Math.ceil(L/pL);
            });
          }
          count = total;
        } else {
          let area = 0;
          if (target==='all-walls') walls.forEach(w=> area+=toM(w.length,w.unit)*toM(w.height,w.unit));
          else if (target.startsWith('wall-')){ const w=findWall(target.split('-')[1]); if (w) area = toM(w.length,w.unit)*toM(w.height,w.unit); }
          const matA = toM(len,lenUnit)*toM(wid,widUnit);
          count = area / matA;
        }

        const countRounded = Math.ceil(count);
        const withExtra = Math.ceil(count * 1.1);
        const price = parseNum(div.querySelector('.price').value);
        const total = Math.ceil(count) * price;
        const totalWithExtra = withExtra * price;
        const sym = currencySymbols[currency] || '‚Ç∏';

        res.innerHTML = `–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: ${countRounded} —à—Ç<br>–° –∑–∞–ø–∞—Å–æ–º: ${withExtra} —à—Ç<br>–¶–µ–Ω–∞ –∑–∞ —à—Ç: ${sym}${price.toLocaleString()}<br><strong>–ò—Ç–æ–≥–æ: ${sym}${total.toLocaleString()}</strong><br><strong>–ò—Ç–æ–≥–æ —Å –∑–∞–ø–∞—Å–æ–º: ${sym}${totalWithExtra.toLocaleString()}</strong>`;
        saveToStorage();
      };

      return div;
    }

    function updateAllResults(){
      document.querySelectorAll('.material').forEach(m=>{
        const calcBtn = m.querySelector('.calc'); if (calcBtn) calcBtn.click();
        const note = m.querySelector('.price-row small'); if (note) note.textContent = `(${currencySymbols[currency] || '‚Ç∏'})`;
      });
    }

    // ---- export PDF (html2canvas -> jsPDF to support –∫–∏—Ä–∏–ª–ª–∏—Ü—É) ----
    async function exportPDF(){
      // Build report HTML inside hidden container
      const report = document.getElementById('reportPrint');
      report.innerHTML = '';
      const h1 = document.createElement('h2'); h1.textContent = 'üß± RemontCalc ‚Äî –†–∞—Å—á—ë—Ç –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤'; report.appendChild(h1);
      report.appendChild(document.createElement('hr'));

      const date = new Date();
      const dateStr = date.toLocaleDateString('ru-RU');
      const dnode = document.createElement('div'); dnode.style.marginBottom='8px'; dnode.textContent = '–û—Ç—á—ë—Ç —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω: ' + dateStr; report.appendChild(dnode);

      // Walls
      const wallsTitle = document.createElement('div'); wallsTitle.textContent='–°—Ç–µ–Ω—ã:'; wallsTitle.style.fontWeight='600'; report.appendChild(wallsTitle);
      walls.forEach(w=>{
        const area = (toM(w.length,w.unit)*toM(w.height,w.unit)).toFixed(2);
        const el = document.createElement('div'); el.textContent = `–°—Ç–µ–Ω–∞ ${w.id}: ${w.length}${w.unit} x ${w.height}${w.unit} ‚Äî ${area} –º¬≤`; report.appendChild(el);
      });
      report.appendChild(document.createElement('hr'));

      // Materials
      const matTitle = document.createElement('div'); matTitle.textContent='–ú–∞—Ç–µ—Ä–∏–∞–ª—ã:'; matTitle.style.fontWeight='600'; report.appendChild(matTitle);
      let grandTotal = 0; let grandTotalWithExtra = 0;
      [...materialsContainer.querySelectorAll('.material')].forEach(m=>{
        const type = m.querySelector('.type').selectedOptions[0].textContent;
        const target = m.querySelector('.target').selectedOptions[0]?.textContent || '-';

        const resDiv = m.querySelector('.result');
        const price = parseNum(m.querySelector('.price')?.value);
        const entry = document.createElement('div'); entry.style.marginTop='6px';
        entry.innerHTML = `<strong>${type}</strong> ‚Äî ${target}`;
        report.appendChild(entry);
        if (resDiv && resDiv.innerText){
          resDiv.innerText.split('\n').forEach(row=>{ const r = document.createElement('div'); r.textContent = row; report.appendChild(r); });
          const matchTotal = resDiv.innerText.match(/–ò—Ç–æ–≥–æ:\s*.*?([\d\s,]+)/);
          const matchWith = resDiv.innerText.match(/–ò—Ç–æ–≥–æ —Å –∑–∞–ø–∞—Å–æ–º:\s*.*?([\d\s,]+)/);
          if (matchTotal){ const v = parseFloat(matchTotal[1].replace(/\s+/g,'')); if (!isNaN(v)) grandTotal += v; }
          if (matchWith){ const v = parseFloat(matchWith[1].replace(/\s+/g,'')); if (!isNaN(v)) grandTotalWithExtra += v; }
        } else {
          const note = document.createElement('div'); note.textContent = '‚Äî –Ω–µ—Ç —Ä–∞—Å—á—ë—Ç–∞'; report.appendChild(note);
        }
      });

      const totalEl = document.createElement('div'); totalEl.style.marginTop='12px'; totalEl.style.fontWeight='700'; totalEl.textContent = `–û–±—â–∞—è —Å—É–º–º–∞ (–±–µ–∑ –∑–∞–ø–∞—Å–∞): ${currencySymbols[currency]||'‚Ç∏'}${Number(grandTotal).toLocaleString()}`; report.appendChild(totalEl);
      const totalWithEl = document.createElement('div'); totalWithEl.style.marginTop='6px'; totalWithEl.style.fontWeight='700'; totalWithEl.textContent = `–û–±—â–∞—è —Å—É–º–º–∞ (—Å –∑–∞–ø–∞—Å–æ–º): ${currencySymbols[currency]||'‚Ç∏'}${Number(grandTotalWithExtra).toLocaleString()}`; report.appendChild(totalWithEl);

      // Wait for fonts to load then render
      await document.fonts.ready;
      const bbox = report.getBoundingClientRect();
      const scale = 2; // higher for better quality
      const canvas = await html2canvas(report, { scale: scale, useCORS: true, backgroundColor: '#ffffff' });
      const imgData = canvas.toDataURL('image/jpeg', 0.95);
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF({ unit: 'pt', format: 'a4' });
      const pageWidth = pdf.internal.pageSize.getWidth();
      const pageHeight = pdf.internal.pageSize.getHeight();
      const imgProps = { width: canvas.width, height: canvas.height };
      const ratio = Math.min(pageWidth / imgProps.width, pageHeight / imgProps.height);
      const imgWidth = imgProps.width * ratio;
      const imgHeight = imgProps.height * ratio;
      pdf.addImage(imgData, 'JPEG', (pageWidth - imgWidth)/2, 20, imgWidth, imgHeight);
      pdf.save('remontcalc_report.pdf');
    }

    document.getElementById('exportPdf').onclick = exportPDF;

    // ---- init ----
    document.getElementById('addWall').onclick = ()=>{ createWall(); saveToStorage(); };
    createWall(); window.addEventListener('beforeunload', saveToStorage);
    loadFromStorage(); updateAllResults();
  </script>
</body>
</html>
