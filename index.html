<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —Ä–µ–º–æ–Ω—Ç–∞</title>
  <meta name="theme-color" content="#1976d2">
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="icon-192.png" type="image/png">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —Ä–µ–º–æ–Ω—Ç–∞">
  <link rel="apple-touch-icon" href="icon-512.png">

  <style>
    :root {
      --primary: #007bff;
      --danger: #dc3545;
      --bg: #eef2f6;
      --radius: 12px;
    }
    body {
      font-family: 'Segoe UI', Roboto, Arial, sans-serif;
      background: var(--bg);
      color: #333;
      margin: 0;
      padding: 10px;
      line-height: 1.5;
    }
    h2,h3,h4 {
      color: #2c3e50;
      border-bottom: 2px solid #aec6cf;
      padding-bottom: 6px;
      margin-top: 12px;
    }
    .container { max-width: 900px; margin: 0 auto; padding-bottom: 60px; }
    .wall, .material {
      background: #fff; padding: 15px; margin: 10px 0; border-radius: var(--radius);
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }
    label {
      display: flex; align-items: center; justify-content: space-between;
      gap: 6px; margin: 6px 0; flex-wrap: wrap; width: 100%;
    }
    input[type="number"], select {
      flex: 1; min-width: 90px; padding: 8px 10px;
      border: 1px solid #ccc; border-radius: 8px; font-size: 1em; text-align: center;
    }
    .unit-select { width: 70px !important; min-width: 70px !important; padding: 6px 8px; }
    button {
      background: var(--primary); color: white; border: none; border-radius: 10px;
      padding: 10px 14px; cursor: pointer; width: 100%;
      font-size: 1em; margin-top: 8px; transition: background 0.2s;
    }
    button:hover { background: #0056b3; }
    .remove { background: var(--danger); }
    .remove:hover { background: #b92d3a; }
    .controls { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px; }
    .controls button { flex: 1; min-width: 100px; }
    .orientation { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; margin: 6px 0; }
    .result {
      background: #e6f7ff; border-left: 4px solid var(--primary);
      padding: 10px; border-radius: 8px; margin-top: 10px; font-size: 0.95em;
    }
    @media (min-width: 700px) {
      .controls button { width: auto; flex: none; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —Ä–µ–º–æ–Ω—Ç–∞ üß±</h2>

    <div class="controls">
      <button id="saveProject">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <button id="loadProject">üìÇ –ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
      <button id="clearProject" class="remove">üóë –û—á–∏—Å—Ç–∏—Ç—å</button>
    </div>

    <h3>–°—Ç–µ–Ω—ã</h3>
    <div id="walls"></div>
    <button id="addWall">+ –î–æ–±–∞–≤–∏—Ç—å —Å—Ç–µ–Ω—É</button>

    <hr>

    <h3>–ú–∞—Ç–µ—Ä–∏–∞–ª—ã</h3>
    <div id="materials"></div>
    <button id="addMaterial">+ –î–æ–±–∞–≤–∏—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª</button>
  </div>

  <script>
    const wallsContainer = document.getElementById('walls');
    const materialsContainer = document.getElementById('materials');
    let walls = [];
    let wallCount = 0;
    const DEFAULT_UNIT = 'm';
    const parseNum = v => parseFloat(v) || 0;
    const toM = (v,u)=>u==='cm'?v/100:v;
    const findWall = id => walls.find(w => w.id == id);

    // ---------- LocalStorage ----------
    function saveToStorage() {
      const data = {
        walls,
        materials: [...materialsContainer.querySelectorAll('.material')].map(m => ({
          type: m.querySelector('.type').value,
          target: m.querySelector('.target').value,
          len: parseNum(m.querySelector('.mlen').value),
          wid: parseNum(m.querySelector('.mwid').value),
          lenUnit: m.querySelectorAll('.unit-select')[0]?.value,
          widUnit: m.querySelectorAll('.unit-select')[1]?.value,
          orient: m.querySelector('input[type="radio"]:checked')?.value || "vertical"
        }))
      };
      localStorage.setItem("repair_calc_project", JSON.stringify(data));
    }

    function loadFromStorage() {
      const data = JSON.parse(localStorage.getItem("repair_calc_project") || "{}");
      if (!data.walls) return;
      walls = []; wallsContainer.innerHTML = ""; materialsContainer.innerHTML = ""; wallCount = 0;
      data.walls.forEach(w => createWall(w));
      data.materials?.forEach(m => {
        const div = createMaterial(m);
        div.querySelector('.type').value = m.type;
        div.querySelector('.target').value = m.target;
        div.querySelector('.mlen').value = m.len;
        div.querySelector('.mwid').value = m.wid;
        div.querySelectorAll('.unit-select')[0].value = m.lenUnit;
        div.querySelectorAll('.unit-select')[1].value = m.widUnit;
        if (m.type === "panel") {
          div.querySelectorAll('input[type="radio"]').forEach(r=>r.checked=(r.value===m.orient));
        }
      });
      updateTargets();
    }

    function clearStorage() {
      if (confirm("–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë?")) {
        localStorage.removeItem("repair_calc_project");
        location.reload();
      }
    }

    document.getElementById("saveProject").onclick = () => { saveToStorage(); alert("‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!"); };
    document.getElementById("loadProject").onclick = loadFromStorage;
    document.getElementById("clearProject").onclick = clearStorage;

    // ---------- –û—Å–Ω–æ–≤–Ω—ã–µ ----------
    const unitSelectHtml = (def=DEFAULT_UNIT)=>`
      <select class="unit-select">
        <option value="m" ${def==='m'?'selected':''}>–º</option>
        <option value="cm" ${def==='cm'?'selected':''}>—Å–º</option>
      </select>`;

    function updateTargets() {
      document.querySelectorAll('.target').forEach(sel=>{
        const prev = sel.value;
        sel.innerHTML = '<option value="">- –í—ã–±–µ—Ä–∏—Ç–µ —Ü–µ–ª—å -</option>';
        if (walls.length>0)
          sel.innerHTML += `<option value="all-walls">–í—Å–µ —Å—Ç–µ–Ω—ã</option><option value="all-floors">–í—Å–µ –ø–æ–ª—ã</option>`;
        walls.forEach(w=>{
          const area = toM(w.length,w.unit)*toM(w.height,w.unit);
          sel.innerHTML += `<option value="wall-${w.id}">–°—Ç–µ–Ω–∞ ${w.id} (${area.toFixed(2)} –º¬≤)</option>`;
          if(w.floor){
            const fa=toM(w.floor.length,w.floor.unit)*toM(w.floor.width,w.floor.unit);
            sel.innerHTML += `<option value="floor-${w.id}">–ü–æ–ª ${w.id} (${fa.toFixed(2)} –º¬≤)</option>`;
          }
        });
        if([...sel.options].some(o=>o.value===prev)) sel.value=prev;
      });
    }

    // ---------- –°—Ç–µ–Ω—ã ----------
    function createWall(existing=null){
      wallCount++;
      const id=wallCount;
      const wall=existing || {id,length:0,height:0,unit:DEFAULT_UNIT,inner:0,outer:0,floor:null};
      wall.id=id;
      walls.push(wall);

      const div=document.createElement('div');
      div.className='wall';
      div.innerHTML=`
        <h4>–°—Ç–µ–Ω–∞ ${id}</h4>
        <label>–î–ª–∏–Ω–∞: <span class="dim-group"><input type="number" class="len" value="${wall.length}">${unitSelectHtml(wall.unit)}</span></label>
        <label>–í—ã—Å–æ—Ç–∞: <span class="dim-group"><input type="number" class="hei" value="${wall.height}">${unitSelectHtml(wall.unit)}</span></label>
        <label>–í–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö —É–≥–ª–æ–≤: <input type="number" class="in" value="${wall.inner}" min="0" max="10" style="width:60px;"></label>
        <label>–ù–∞—Ä—É–∂–Ω—ã—Ö —É–≥–ª–æ–≤: <input type="number" class="out" value="${wall.outer}" min="0" max="10" style="width:60px;"></label>
        <label><input type="checkbox" class="fchk" ${wall.floor?'checked':''}> –£—á–∏—Ç—ã–≤–∞—Ç—å –ø–æ–ª</label>
        <div class="floor" style="display:${wall.floor?'block':'none'};">
          <label>–î–ª–∏–Ω–∞ –ø–æ–ª–∞: <span class="dim-group"><input type="number" class="flen" value="${wall.floor?.length||0}">${unitSelectHtml(wall.floor?.unit||'m')}</span></label>
          <label>–®–∏—Ä–∏–Ω–∞ –ø–æ–ª–∞: <span class="dim-group"><input type="number" class="fwid" value="${wall.floor?.width||0}">${unitSelectHtml(wall.floor?.unit||'m')}</span></label>
        </div>
        <button class="remove">–£–¥–∞–ª–∏—Ç—å</button>
      `;
      const upd=()=>{updateTargets(); saveToStorage();};
      div.querySelector('.len').oninput=e=>{wall.length=parseNum(e.target.value);upd();};
      div.querySelector('.hei').oninput=e=>{wall.height=parseNum(e.target.value);upd();};
      div.querySelector('.in').oninput=e=>{wall.inner=parseNum(e.target.value);upd();};
      div.querySelector('.out').oninput=e=>{wall.outer=parseNum(e.target.value);upd();};
      div.querySelectorAll('.unit-select')[0].onchange=e=>{wall.unit=e.target.value;upd();};
      div.querySelectorAll('.unit-select')[1].onchange=e=>{wall.unit=e.target.value;upd();};
      const fchk=div.querySelector('.fchk');
      fchk.onchange=()=>{
        const floorDiv=div.querySelector('.floor');
        if(fchk.checked){ floorDiv.style.display='block'; wall.floor={length:0,width:0,unit:DEFAULT_UNIT}; }
        else{ floorDiv.style.display='none'; wall.floor=null; }
        upd();
      };
      div.querySelector('.flen').oninput=e=>{if(wall.floor)wall.floor.length=parseNum(e.target.value);upd();};
      div.querySelector('.fwid').oninput=e=>{if(wall.floor)wall.floor.width=parseNum(e.target.value);upd();};
      div.querySelectorAll('.floor .unit-select').forEach(s=>s.onchange=e=>{if(wall.floor)wall.floor.unit=e.target.value;upd();});
      div.querySelector('.remove').onclick=()=>{walls=walls.filter(w=>w.id!==id);div.remove();upd();};
      wallsContainer.appendChild(div);
      updateTargets();
    }

    // ---------- –ú–∞—Ç–µ—Ä–∏–∞–ª—ã ----------
    function createMaterial(existing=null){
      const div=document.createElement('div');
      div.className='material';
      const uid=Date.now()+Math.random();
      div.innerHTML=`
        <h4>–ú–∞—Ç–µ—Ä–∏–∞–ª</h4>
        <label>–¢–∏–ø:
          <select class="type">
            <option value="tile">–ü–ª–∏—Ç–∫–∞</option>
            <option value="plinth">–ü–ª–∏–Ω—Ç—É—Å</option>
            <option value="linoleum">–õ–∏–Ω–æ–ª–µ—É–º</option>
            <option value="panel">–°—Ç–µ–Ω–æ–≤–∞—è –ø–∞–Ω–µ–ª—å</option>
            <option value="wallpaper">–û–±–æ–∏</option>
          </select>
        </label>
        <label>–ü—Ä–∏–º–µ–Ω–∏—Ç—å –∫: <select class="target"></select></label>
        <label><span>–î–ª–∏–Ω–∞:</span><span class="dim-group"><input type="number" class="mlen" value="${existing?.len||0}">${unitSelectHtml(existing?.lenUnit||'m')}</span></label>
        <label><span>–®–∏—Ä–∏–Ω–∞:</span><span class="dim-group"><input type="number" class="mwid" value="${existing?.wid||0}">${unitSelectHtml(existing?.widUnit||'m')}</span></label>
        <div class="orientation" style="display:none;">
          <span style="font-weight:500;color:#444;">–ú–æ–Ω—Ç–∞–∂ –ø–∞–Ω–µ–ª–µ–π:</span>
          <label><input type="radio" name="orient-${uid}" value="vertical" checked> –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ</label>
          <label><input type="radio" name="orient-${uid}" value="horizontal"> –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ</label>
        </div>
        <button class="calc">–†–∞—Å—Å—á–∏—Ç–∞—Ç—å</button>
        <div class="result"></div>
      `;
      materialsContainer.appendChild(div);
      updateTargets();
      const typeSel=div.querySelector('.type');
      const orientDiv=div.querySelector('.orientation');
      const refresh=()=>{ orientDiv.style.display = typeSel.value==='panel'?'flex':'none'; saveToStorage(); };
      typeSel.onchange=refresh; refresh();

      div.querySelector('.calc').onclick=()=>{
        const type=div.querySelector('.type').value;
        const target=div.querySelector('.target').value;
        const len=parseNum(div.querySelector('.mlen').value);
        const wid=parseNum(div.querySelector('.mwid').value);
        const lenUnit=div.querySelectorAll('.unit-select')[0]?.value||'m';
        const widUnit=div.querySelectorAll('.unit-select')[1]?.value||'m';
        const res=div.querySelector('.result');
        if(!target){res.innerHTML='‚ùå –í—ã–±–µ—Ä–∏—Ç–µ —Ü–µ–ª—å';return;}
        if(len<=0){res.innerHTML='‚ö†Ô∏è –í–≤–µ–¥–∏—Ç–µ –¥–ª–∏–Ω—É –º–∞—Ç–µ—Ä–∏–∞–ª–∞';return;}
        let count=0;

        if(type==='plinth'){
          let total=0; if(target==='all-walls') walls.forEach(w=> total+=toM(w.length,w.unit));
          else if(target.startsWith('wall-')){const w=findWall(target.split('-')[1]); if(w) total=toM(w.length,w.unit);}
          count=total/toM(len,lenUnit);
        }
        else if(type==='panel'){
          const orient=div.querySelector('input[type="radio"]:checked')?.value||'vertical';
          let total=0; if(target==='all-walls'){
            walls.forEach(w=>{
              const L=toM(w.length,w.unit),H=toM(w.height,w.unit);
              const pL=toM(len,lenUnit),pW=toM(wid,widUnit);
              total+=orient==='vertical' ? Math.ceil(H/pL)*Math.ceil(L/pW) : Math.ceil(H/pW)*Math.ceil(L/pL);
            });
          } count=total;
        }
        else{
          let area=0;
          if(target==='all-walls') walls.forEach(w=> area+=toM(w.length,w.unit)*toM(w.height,w.unit));
          else if(target.startsWith('wall-')){const w=findWall(target.split('-')[1]); if(w) area=toM(w.length,w.unit)*toM(w.height,w.unit);}
          const matA=toM(len,lenUnit)*toM(wid,widUnit);
          count=area/matA;
        }
        const withExtra=Math.ceil(count*1.1);
        res.innerHTML=`–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: ${Math.ceil(count)} —à—Ç<br><strong>–° –∑–∞–ø–∞—Å–æ–º: ${withExtra} —à—Ç</strong>`;
        saveToStorage();
      };
      return div;
    }

    // ---------- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ----------
    document.getElementById('addWall').onclick=()=>{createWall();saveToStorage();};
    document.getElementById('addMaterial').onclick=()=>{createMaterial();saveToStorage();};
    createWall();
    window.addEventListener("beforeunload", saveToStorage);
    loadFromStorage();
  </script>
</body>
</html>
